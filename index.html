<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¢×¨×›×ª ×œ×•×– ×“×™×’×™×˜×œ×™×ª - ×‘×™×ª ×“×¨×•×¨ ğŸ³ï¸â€ğŸŒˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ×¦×‘×¢×™× × ×¢×™××™× ×•×¨×›×™× */
            --bg-main: #f0fdfa; /* ×¨×§×¢ ×›×œ×œ×™ ×‘×”×™×¨ ×××•×“ */
            --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --bg-card: rgba(255, 255, 255, 0.98);
            --border: #cbd5e1;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --primary: #8b5cf6;
            --success: #10b981;
            --header-bg: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden; /* ×œ×× ×•×¢ ×’×œ×™×œ×” ×©×œ ×›×œ ×”×¢××•×“ ×‘×’×œ×œ ×”×§×™×©×•×˜×™× */
        }

        /* --- ×ª×™×§×•×Ÿ ×“××•×™×•×ª ×¦×¤×•×ª --- */
        .decoration {
            position: fixed;
            z-index: 0; /* × ××•×š, ××‘×œ ××¢×œ ×”×¨×§×¢ */
            pointer-events: none; /* ×›×“×™ ×©××¤×©×¨ ×™×”×™×” ×œ×œ×—×•×¥ ×“×¨×›×Ÿ */
            animation: float 6s ease-in-out infinite;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        /* ××™×§×•××™× ××¡×˜×¨×˜×’×™×™× ×›×“×™ ×©×™×¦×™×¦×• */
        .dec-1 { top: 10px; left: 10px; font-size: 4rem; animation-delay: 0s; }
        .dec-2 { bottom: 20px; right: 10px; font-size: 5rem; animation-delay: 2s; }
        .dec-3 { top: 15%; right: -20px; font-size: 6rem; opacity: 0.4; animation-delay: 1s; } 
        .dec-4 { bottom: 15%; left: -20px; font-size: 4rem; opacity: 0.6; animation-delay: 3s; }

        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 10; /* ×ª×•×›×Ÿ ×ª××™×“ ××¢×œ ×”×§×™×©×•×˜×™× */
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            text-align: center;
            border: 2px solid white;
        }

        .header h1 {
            font-family: 'Varela Round', sans-serif;
            font-size: 2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        /* --- ×›×¨×˜×™×¡×™× --- */
        .card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid white;
        }

        /* --- ×˜××‘×™× --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }
        
        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.7);
            border: 1px solid white;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            color: var(--text-secondary);
        }
        
        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
            transform: scale(1.02);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ×˜×‘×œ×” ×•×¡×˜×™×§×™ (×”×ª×™×§×•×Ÿ ×”×—×©×•×‘) --- */
        .table-wrapper {
            width: 100%;
            overflow-x: auto; /* ×××¤×©×¨ ×’×œ×™×œ×” */
            border-radius: 12px;
            border: 1px solid var(--border);
            max-height: 75vh; /* ×’×œ×™×œ×” ×× ×›×™×ª ×× ×¦×¨×™×š */
            overflow-y: auto;
            position: relative;
        }

        .schedule-table {
            width: 100%;
            min-width: 900px; /* ××›×¨×™×— ×¨×•×—×‘ ×›×“×™ ×©×”×’×œ×™×œ×” ×ª×¢×‘×•×“ */
            border-collapse: separate; /* ×—×•×‘×” ×œ-Sticky */
            border-spacing: 0;
        }

        .schedule-table th, .schedule-table td {
            border-bottom: 1px solid var(--border);
            border-left: 1px solid var(--border);
            padding: 0;
            background: white;
        }

        /* ×›×•×ª×¨×•×ª ×™××™× (×œ××¢×œ×”) */
        .schedule-table th {
            padding: 12px;
            background: var(--header-bg);
            position: sticky;
            top: 0;
            z-index: 30; /* ××¢×œ ×”×ª××™× ×”×¨×’×™×œ×™× */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* ×¢××•×“×ª ×”×©×¢×•×ª (×¦×“ ×™××™×Ÿ - ×“×‘×™×§) */
        .schedule-table .time-cell {
            position: sticky;
            right: 0;
            background: var(--header-bg);
            z-index: 20; /* ××¢×œ ×ª××™× ×¨×’×™×œ×™×, ××ª×—×ª ×œ×›×•×ª×¨×•×ª */
            width: 80px;
            min-width: 80px;
            font-weight: 700;
            text-align: center;
            border-left: 2px solid #cbd5e1; /* ×¤×¡ ×”×¤×¨×“×” ××•×“×’×© */
            vertical-align: middle;
            color: var(--primary);
        }

        /* ×”×¤×™× ×” ×”×™×× ×™×ª ×”×¢×œ×™×•× ×” (×”×¦×˜×œ×‘×•×ª) - ×—×™×™×‘×ª ×œ×”×™×•×ª ×”×›×™ ×œ××¢×œ×” */
        .schedule-table th:first-child {
            position: sticky;
            right: 0;
            top: 0;
            z-index: 50; /* ×”×›×™ ×’×‘×•×”! */
            background: var(--header-bg);
            border-left: 2px solid #cbd5e1;
            z-index: 50 !important;
        }

        /* --- Textarea --- */
        textarea.auto-expand {
            width: 100%;
            min-height: 50px; /* ×’×•×‘×” ×”×ª×—×œ×ª×™ × ×•×— */
            padding: 8px;
            border: none;
            resize: none;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            background: transparent;
            text-align: center;
            line-height: 1.4;
            display: block;
        }
        
        textarea.auto-expand:focus {
            background: #fdf2f8; /* ×•×¨×“×¨×“ ×¢×“×™×Ÿ ×‘×¤×•×§×•×¡ */
            outline: none;
            box-shadow: inset 0 0 0 2px var(--primary);
        }

        /* ×ª××™× ××™×•×—×“×™× */
        .fixed-cell {
            background: #f1f5f9 !important;
            padding: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            min-height: 50px;
        }

        .suggested-cell { background: #fffbeb !important; }

        /* ×›×¤×ª×•×¨×™× */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-primary); }
        .btn:active { transform: scale(0.96); }

        /* ×ª×’×™×•×ª ×©××•×ª (×œ×•×– ×›×•×œ×œ) */
        .student-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
            color: white;
            font-weight: bold;
        }
        /* ×¤×œ×˜×ª ×¦×‘×¢×™× ×œ×©××•×ª */
        .tag-c1 { background: #ef4444; } .tag-c2 { background: #3b82f6; }
        .tag-c3 { background: #10b981; } .tag-c4 { background: #f59e0b; }
        .tag-c5 { background: #8b5cf6; } .tag-c6 { background: #ec4899; }
        .tag-c7 { background: #06b6d4; } .tag-c8 { background: #84cc16; }
        .tag-c9 { background: #6366f1; } .tag-c10 { background: #d946ef; }
        .tag-c11 { background: #14b8a6; } .tag-c12 { background: #f97316; }
        .tag-c13 { background: #64748b; } .tag-c14 { background: #a855f7; }
        .tag-c15 { background: #e11d48; }

        /* ×§×•× ×˜×¨×•×œ×¡ */
        .controls-bar {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        select, input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: inherit;
        }

        /* ×”×“×¤×¡×” */
        @media print {
            .decoration, .tabs, .header, .btn, .controls-bar, .toast { display: none !important; }
            body, .card { background: white; padding: 0; margin: 0; border: none; box-shadow: none; }
            .table-wrapper { overflow: visible; border: none; }
            .schedule-table { width: 100%; min-width: 0; }
            .schedule-table th, .schedule-table td { border: 1px solid black; font-size: 10pt; }
            .student-tag { border: 1px solid #000; color: black !important; background: white !important; }
            textarea { white-space: pre-wrap; border: none; height: auto; }
        }

        /* ××•×“×œ ×•×”×•×“×¢×•×ª */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            z-index: 2000; transition: 0.4s; opacity: 0;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.danger { background: #ef4444; }

        .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="decoration dec-1">ğŸŒˆ</div>
    <div class="decoration dec-2">ğŸ¦„</div>
    <div class="decoration dec-3">â˜ï¸</div>
    <div class="decoration dec-4">âœ¨</div>

    <div class="container">
        <div class="header">
            <h1>ğŸ“… ×œ×•×– ×‘×™×ª ×“×¨×•×¨ ğŸ³ï¸â€ğŸŒˆ</h1>
            <p id="weekHeaderDisplay">×˜×•×¢×Ÿ ×ª××¨×™×š...</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('student')">ğŸ‘¦ × ×¢×¨×™×.×•×ª</button>
            <button class="tab" onclick="switchTab('coordinator')">ğŸ‘©â€ğŸ« ×¨×›×–×ª</button>
            <button class="tab" onclick="switchTab('combined')">ğŸ§© ×œ×•×– ×›×•×œ×œ</button>
        </div>

        <div id="student-tab" class="tab-content active">
            <div class="card">
                <div class="controls-bar" style="background: transparent; padding: 0;">
                    <input type="text" id="studentName" placeholder="×”×›× ×¡/×™ ×©× ×¤×¨×˜×™..." style="flex: 1;">
                    <button class="btn btn-primary" onclick="showQuickCopyModal()">âœ¨ ×”×¢×ª×§×” ××”×™×¨×”</button>
                </div>

                <div class="table-wrapper">
                    <table class="schedule-table" id="studentTable">
                        </table>
                </div>

                <button class="btn btn-success" style="width: 100%; margin-top: 20px; justify-content: center;" onclick="submitSchedule()">
                    ğŸš€ ×©×œ×—/×™ ×œ××™×©×•×¨
                </button>
            </div>
        </div>

        <div id="coordinator-tab" class="tab-content">
            <div class="card">
                <div class="controls-bar">
                    <h3>××™×©×•×¨ ×‘×§×©×•×ª</h3>
                    <select id="coordWeekSelect" onchange="loadSubmissions()"></select>
                    <button class="btn btn-secondary" onclick="toggleArchive()" id="archiveBtn">ğŸ“¦ ××¨×›×™×•×Ÿ</button>
                </div>
                <div id="submissionsList"></div>
            </div>
        </div>

        <div id="combined-tab" class="tab-content">
            <div class="card">
                <div class="controls-bar">
                    <select id="combinedWeekSelect" onchange="loadCombinedView()"></select>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn btn-primary" onclick="downloadICS()">ğŸ“… ×”×•×¨×“ ×œ×™×•××Ÿ</button>
                    <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                </div>
                
                <div id="combinedViewContent" class="table-wrapper">
                    <p style="text-align:center; padding: 20px;">×‘×—×¨ ×©×‘×•×¢ ×œ×”×¦×’×”...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="quickCopyModal" class="modal">
        <div class="modal-content">
            <h3>×”×¢×ª×§×” ××”×™×¨×” âœ¨</h3>
            <p style="margin-bottom: 10px; font-size: 14px; color: #666;">××œ× ×ª×•×›×Ÿ ×•×‘×—×¨ ×™×•× ×•×©×¢×•×ª ×œ×”×—×œ×” ×’×•×¨×¤×ª.</p>
            <input type="text" id="qcContent" placeholder="××” ×”×¤×¢×™×œ×•×ª? (×œ××©×œ: ×œ×™××•×“×™×)" style="width: 100%; margin-bottom: 10px;">
            <select id="qcDay" style="width: 100%; margin-bottom: 10px;"></select>
            <div id="qcTimes" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 15px;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="document.getElementById('quickCopyModal').classList.remove('show')">×‘×™×˜×•×œ</button>
                <button class="btn btn-primary" onclick="applyQuickCopy()">×”×—×œ</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // --- ×§×•× ×¤×™×’×•×¨×¦×™×” ---
        const firebaseConfig = {
            apiKey: "AIzaSyD5Ma2GAqiPFKurMedUgU6Qgl-qk_Uop-s",
            authDomain: "beit-dror1.firebaseapp.com",
            databaseURL: "https://beit-dror1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "beit-dror1",
            storageBucket: "beit-dror1.firebasestorage.app",
            messagingSenderId: "397103626096",
            appId: "1:397103626096:web:6f12003cc1447ea1c201b5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- ××‘× ×” ×”×œ×•×– ---
        const structure = {
            days: ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'],
            times: [
                { t: '06:30', type: 'free' },
                { t: '07:00', type: 'fixed', content: '×.×‘×•×§×¨', days: [2] },
                { t: '08:00', type: 'suggested', content: '×œ×™××•×“×™×/×‘×•×§×¨', days: [0,1,2,3,4] },
                { t: '14:00', type: 'fixed', content: '×.×¦×”×¨×™×™×', days: [0,1,2,3,4,5,6] },
                { t: '17:00', type: 'fixed', content: '×›× ×™×¡×”', days: [1,2,3,5,6] },
                { t: '19:30', type: 'fixed', content: '×.×¢×¨×‘', days: [0,1,2,3,4,5,6] },
                { t: '22:00', type: 'fixed', content: '×›× ×™×¡×”', days: [0,1,2,3,5,6] }
            ]
        };

        let currentWeek = {};
        let studentData = {};
        let showArchive = false;

        // --- ××ª×—×•×œ ---
        window.addEventListener('DOMContentLoaded', () => {
            initDates();
            renderStudentTable();
            loadWeeks();
            initQuickCopy();
        });

        function initDates() {
            const d = new Date();
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 6 ? 1 : 7); // × ×§×¡×˜ ×¡×× ×“×™×™
            const nextSun = new Date(d.setDate(diff));
            nextSun.setHours(0,0,0,0);
            const nextSat = new Date(nextSun);
            nextSat.setDate(nextSun.getDate() + 6);
            
            const fmt = date => `${date.getDate()}/${date.getMonth()+1}`;
            currentWeek = {
                id: `${fmt(nextSun)}-${fmt(nextSat)}`,
                start: nextSun,
                display: `${fmt(nextSun)} - ${fmt(nextSat)}`
            };
            document.getElementById('weekHeaderDisplay').textContent = `×©×‘×•×¢: ${currentWeek.display}`;
        }

        // --- ×˜×‘×œ×ª ×—× ×™×š ---
        function renderStudentTable() {
            const table = document.getElementById('studentTable');
            let html = '<thead><tr><th>×©×¢×”</th>';
            structure.days.forEach(d => html += `<th>${d}</th>`);
            html += '</tr></thead><tbody>';

            // ××™×¤×•×™ ×–×× ×™× ×›×“×™ ×œ×× ×•×¢ ×›×¤×™×œ×•×™×•×ª ×ª×¦×•×’×”
            const timesMap = {};
            structure.times.forEach((slot, idx) => {
                if(!timesMap[slot.t]) timesMap[slot.t] = [];
                timesMap[slot.t].push({ ...slot, idx });
            });

            Object.keys(timesMap).sort().forEach(timeStr => {
                const slots = timesMap[timeStr];
                html += `<tr><td class="time-cell">${timeStr}</td>`;
                
                structure.days.forEach((dayName, dayIdx) => {
                    // ×‘×“×™×§×” ×× ×™×© ××™×¨×•×¢ ×§×‘×•×¢ ××• ××•×¦×¢ ×‘×™×•× ×”×–×”
                    const fixed = slots.find(s => s.type === 'fixed' && s.days?.includes(dayIdx));
                    const sugg = slots.find(s => s.type === 'suggested' && s.days?.includes(dayIdx));
                    
                    if (fixed) {
                        html += `<td class="fixed-cell">${fixed.content}</td>`;
                    } else {
                        // ×ª× ×œ×›×ª×™×‘×”
                        // ×× ×—× ×• ××©×ª××©×™× ×‘××™× ×“×§×¡ ×”××§×•×¨×™ ×©×œ ×”×©×¢×” ×”×¨××©×•× ×” ×©××ª××™××” ×œ×–××Ÿ ×”×–×”
                        const baseIdx = slots[0].idx; 
                        const key = `${dayIdx}-${baseIdx}`;
                        const val = studentData[key] || '';
                        const placeholder = sugg ? (sugg.content || '×”×¦×¢×”') : '';
                        const bgClass = sugg ? 'suggested-cell' : '';
                        
                        html += `<td class="${bgClass}">
                            <textarea class="auto-expand" 
                                oninput="updateStudentData('${key}', this.value); autoGrow(this)"
                                placeholder="${placeholder}">${val}</textarea>
                        </td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
            document.querySelectorAll('textarea').forEach(autoGrow);
        }

        function autoGrow(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function updateStudentData(key, val) {
            if(val.trim()) studentData[key] = val;
            else delete studentData[key];
        }

        // --- ×©×œ×™×—×” ---
        async function submitSchedule() {
            const name = document.getElementById('studentName').value;
            if(!name) return showToast('× × ×œ××œ× ×©×', 'danger');
            if(Object.keys(studentData).length === 0) return showToast('×”×œ×•×– ×¨×™×§', 'danger');

            const payload = {
                studentName: name,
                weekDisplay: currentWeek.display,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                archived: false,
                data: Object.entries(studentData).map(([k, v]) => {
                    const [d, t] = k.split('-');
                    return { d: parseInt(d), t: parseInt(t), content: v, status: 'pending' };
                })
            };

            await db.ref('submissions').push(payload);
            showToast('× ×©×œ×— ×‘×”×¦×œ×—×”! ğŸ‰');
            studentData = {};
            document.getElementById('studentName').value = '';
            renderStudentTable();
        }

        // --- ×¨×›×–×ª ---
        async function loadSubmissions() {
            const week = document.getElementById('coordWeekSelect').value;
            const snap = await db.ref('submissions').once('value');
            const list = document.getElementById('submissionsList');
            list.innerHTML = '';

            let subs = [];
            snap.forEach(c => subs.push({ id: c.key, ...c.val() }));
            
            // ×¡×™× ×•×Ÿ ×•××™×•×Ÿ
            subs = subs.filter(s => (week ? s.weekDisplay === week : true) && !!s.archived === showArchive);
            subs.sort((a,b) => b.timestamp - a.timestamp);

            if(subs.length === 0) list.innerHTML = '<p style="text-align:center; padding:20px;">××™×Ÿ ×‘×§×©×•×ª</p>';

            subs.forEach(sub => {
                const date = new Date(sub.timestamp).toLocaleString('he-IL');
                let card = `<div class="card" style="border-right: 4px solid var(--primary);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>${sub.studentName}</strong>
                        <small>${date}</small>
                    </div>
                    <div style="margin-bottom:10px;">
                        ${sub.data.map(d => `<span class="student-tag tag-c${(d.d%15)+1}">${structure.days[d.d]}: ${d.content}</span>`).join(' ')}
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="btn btn-secondary btn-sm" onclick="toggleArchiveItem('${sub.id}', ${!sub.archived})">
                            ${sub.archived ? '×©×—×–×¨' : '××¨×›×™×•×Ÿ'}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${sub.id}')">××—×§</button>
                    </div>
                </div>`;
                list.innerHTML += card;
            });
        }

        // --- ×œ×•×– ×›×•×œ×œ ×•×’×•×’×œ ×™×•××Ÿ ---
        async function loadCombinedView() {
            const week = document.getElementById('combinedWeekSelect').value;
            if(!week) return;

            const snap = await db.ref('submissions').once('value');
            const map = {}; // map[timeStr][dayIdx] = [names...]

            snap.forEach(c => {
                const s = c.val();
                if(s.weekDisplay === week && !s.archived) {
                    s.data.forEach(entry => {
                        // ×›××Ÿ × × ×™×— ×©×›×œ ××” ×©× ×©×œ×— ×”×•× "×××•×©×¨" ×œ×¦×•×¨×š ×”×ª×¦×•×’×”, ××• ××¤×©×¨ ×œ×¡× ×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡
                        const timeStr = structure.times[entry.t].t; 
                        if(!map[timeStr]) map[timeStr] = {};
                        if(!map[timeStr][entry.d]) map[timeStr][entry.d] = [];
                        map[timeStr][entry.d].push({ name: s.studentName, content: entry.content });
                    });
                }
            });

            // ×™×¦×™×¨×ª ×˜×‘×œ×”
            let html = '<table class="schedule-table"><thead><tr><th>×©×¢×”</th>';
            structure.days.forEach(d => html += `<th>${d}</th>`);
            html += '</tr></thead><tbody>';

            // ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×©×¢×•×ª ×‘×ª×¦×•×’×”
            const uniqueTimes = [...new Set(structure.times.map(t => t.t))].sort();

            uniqueTimes.forEach(tStr => {
                html += `<tr><td class="time-cell">${tStr}</td>`;
                structure.days.forEach((_, dayIdx) => {
                    // ×‘×“×™×§×ª ×§×‘×•×¢×™×
                    const fixed = structure.times.find(x => x.t === tStr && x.type === 'fixed' && x.days?.includes(dayIdx));
                    if(fixed) {
                        html += `<td class="fixed-cell">${fixed.content}</td>`;
                    } else {
                        // ×ª×•×›×Ÿ ×—× ×™×›×™×
                        const entries = map[tStr]?.[dayIdx];
                        let cellContent = '';
                        if(entries) {
                            entries.forEach((e, i) => {
                                // ×¦×‘×¢ ×œ×¤×™ ×©× ×”×—× ×™×š (×¤×•× ×§×¦×™×™×ª ×’×™×‘×•×‘ ×¤×©×•×˜×”)
                                const colorIdx = (e.name.length + i) % 15 + 1;
                                cellContent += `<div style="margin-bottom:2px;">
                                    <span class="student-tag tag-c${colorIdx}">${e.name}</span>
                                    <span style="font-size:11px;">${e.content}</span>
                                </div>`;
                            });
                        }
                        html += `<td style="vertical-align:top; padding:4px;">${cellContent}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('combinedViewContent').innerHTML = html;
        }

        // --- ×”×•×¨×“×ª ICS (×’×•×’×œ ×™×•××Ÿ) ---
        async function downloadICS() {
            const week = document.getElementById('combinedWeekSelect').value;
            if(!week) return showToast('×‘×—×¨ ×©×‘×•×¢', 'danger');

            // ×¤×™×¨×•×§ ×”×ª××¨×™×š
            const [d1, m1] = week.split(' - ')[0].split('/');
            const currentYear = new Date().getFullYear(); // ×”× ×—×” ×©×–×” ×”×©× ×” ×”× ×•×›×—×™×ª
            const startDate = new Date(currentYear, m1-1, d1);

            const snap = await db.ref('submissions').once('value');
            let events = "";
            
            snap.forEach(c => {
                const s = c.val();
                if(s.weekDisplay === week && !s.archived) {
                    s.data.forEach(e => {
                        const timeStr = structure.times[e.t].t; // "14:00"
                        const [hh, mm] = timeStr.split(':');
                        
                        // ×—×™×©×•×‘ ×–××Ÿ ×”×ª×—×œ×”
                        const evStart = new Date(startDate);
                        evStart.setDate(evStart.getDate() + e.d);
                        evStart.setHours(hh, mm, 0);
                        
                        // ×—×™×©×•×‘ ×–××Ÿ ×¡×™×•× (×‘×¨×™×¨×ª ××—×“×œ ×©×¢×”)
                        const evEnd = new Date(evStart);
                        evEnd.setHours(evEnd.getHours() + 1);

                        const fmt = d => d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
                        
                        events += "BEGIN:VEVENT\n";
                        events += `DTSTART:${fmt(evStart)}\n`;
                        events += `DTEND:${fmt(evEnd)}\n`;
                        events += `SUMMARY:${s.studentName}: ${e.content}\n`;
                        events += "END:VEVENT\n";
                    });
                }
            });

            if(!events) return showToast('××™×Ÿ ××™×¨×•×¢×™×', 'danger');

            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//BeitDror//IL\n${events}END:VCALENDAR`;
            const blob = new Blob([ics], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `schedule_${week.replace('/','-')}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- ×¢×–×¨×™× ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(t+'-tab').classList.add('active');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
            
            if(t==='coordinator') {
                loadWeeks('coordWeekSelect');
                setTimeout(loadSubmissions, 500); // ×˜×¢×™× ×” ××—×¨×™ ×©×”×“×•× ××•×›×Ÿ
            }
            if(t==='combined') {
                loadWeeks('combinedWeekSelect');
            }
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast show ${type}`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function toggleArchive() {
            showArchive = !showArchive;
            document.getElementById('archiveBtn').textContent = showArchive ? 'ğŸ“‚ ×—×–×•×¨ ×œ×¤×¢×™×œ×™×' : 'ğŸ“¦ ××¨×›×™×•×Ÿ';
            loadSubmissions();
        }

        async function toggleArchiveItem(id, status) {
            await db.ref(`submissions/${id}/archived`).set(status);
            loadSubmissions();
        }
        
        async function deleteItem(id) {
            if(confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª?')) {
                await db.ref(`submissions/${id}`).remove();
                loadSubmissions();
            }
        }

        async function loadWeeks(elemId) {
            // ×˜×•×¢×Ÿ ×©×‘×•×¢×•×ª ×§×™×™××™× ×œ×“×¨×•×¤×“××•×Ÿ
            const snap = await db.ref('submissions').once('value');
            const weeks = new Set();
            snap.forEach(s => weeks.add(s.val().weekDisplay));
            
            // ×”××¨×” ×œ×ª××¨×™×›×™× ×œ××™×•×Ÿ
            const sorted = Array.from(weeks).sort((a,b) => {
                const da = a.split(' - ')[0].split('/').reverse().join('');
                const db = b.split(' - ')[0].split('/').reverse().join('');
                return db.localeCompare(da);
            });

            const sel = document.getElementById(elemId || 'coordWeekSelect');
            if(sel) {
                sel.innerHTML = '<option value="">×‘×—×¨ ×©×‘×•×¢</option>';
                sorted.forEach(w => sel.innerHTML += `<option value="${w}">${w}</option>`);
            }
        }

        // --- ×œ×•×’×™×§×ª ×”×¢×ª×§×” ××”×™×¨×” ---
        function initQuickCopy() {
            const sel = document.getElementById('qcDay');
            structure.days.forEach((d, i) => sel.innerHTML += `<option value="${i}">${d}</option>`);
            
            sel.onchange = () => {
                const day = parseInt(sel.value);
                const div = document.getElementById('qcTimes');
                div.innerHTML = '';
                // ×¨×§ ×–×× ×™× ×©××™× × ×§×‘×•×¢×™× ×‘×™×•× ×”×–×”
                structure.times.forEach((t, i) => {
                    const isFixed = t.type === 'fixed' && t.days.includes(day);
                    if(!isFixed) {
                        div.innerHTML += `<div><input type="checkbox" value="${i}" id="t${i}"> <label for="t${i}">${t.t}</label></div>`;
                    }
                });
            }
        }

        function showQuickCopyModal() { document.getElementById('quickCopyModal').classList.add('show'); }
        
        function applyQuickCopy() {
            const txt = document.getElementById('qcContent').value;
            const day = document.getElementById('qcDay').value;
            if(!txt || !day) return;

            document.querySelectorAll('#qcTimes input:checked').forEach(cb => {
                const tIdx = cb.value;
                const key = `${day}-${tIdx}`;
                studentData[key] = txt;
            });
            renderStudentTable();
            document.getElementById('quickCopyModal').classList.remove('show');
        }
    </script>
</body>
</html>
